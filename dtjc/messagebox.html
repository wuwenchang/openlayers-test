<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript" src="../js/jquery-3.5.0.min.js"></script>
    <script type="text/javascript" src="../js/layer/layer.js"></script>
    <script type="text/javascript" src="../js/normal.js"></script>
    <script type="text/javascript" src="../js/tables.js"></script>
    <link href="../css/index.css" rel="stylesheet" />
    <script src="../js/errData.js"></script>
    <script src="../json/accidentData.js"></script>
    <script src="../json/rescuejson.js"></script>
    <script type="text/javascript" src="../js/damap.js"></script>
</head>

<body>
    <div class="allmsg">
        <p><img src="../imgs/s1.png" /><span>实时消息</span></p>
        <div class="msgbox">
            <table id="message">
            </table>
        </div>
    </div>
    <script>
        var actable;
        var page = parent.location.pathname;
        var trafficType = '';
        if (getUrlParam("msg")) {
            var rowsnum = getUrlParam("msg");
            var type = getUrlParam("type");
            console.log(rowsnum, type)
            var iiload = layer.load(1, false);
            
            var time = 5000;
            if (page.includes('page4')) {
                createAccident(rescuejson, {
                    type: 1 + Math.ceil(Math.random() * 5),
                    code: '京A' + (10000 + Math.floor(Math.random() * 90000)),
                    time
                })
                trafficType = 'car'
            } else if (page.includes('page5')) {
                createAccident(rescuejson, {
                    type: Math.random() > 0.6 ? 2 : (Math.random() > 0.3 ? 5 : 6),
                    code: '京A' + (10000 + Math.floor(Math.random() * 90000)),
                    time
                })
                trafficType = 'bus'
            } else if (page.includes('page6')) {
                createAccident(rescuejson, {
                    type: 5,
                    code: '京A' + (10000 + Math.floor(Math.random() * 90000)),
                    time
                })
                trafficType = 'bus'
            } else if (page.includes('page7')) {
                createAccident(rescuejson, {
                    type: 4,
                    code: (1 + Math.floor(Math.random() * 15)) + '号线',
                    time
                })
                trafficType = 'subway'
            } else if (page.includes('page8')) {
                createAccident(rescuejson, {
                    type: 3,
                    code: 'G' + (1000 + Math.floor(Math.random() * 9000)),
                    time
                })
                trafficType = 'train'
            }
            if (!trafficType) {
                setInterval(() => {
                    getErrorTableData()
                }, time)
            }
        }
        function getErrorTableData() {
            $.ajax({
                type: "POST",  //访问WebService使用post方式请求
                cache: false,
                async: false,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                url: getRootPath() + "/Service/GetTable.ashx", //调用WebService的地址和方法名称组合
                data: { tableName: "traffic_accident A,traffic_accident_type B", whereSql: " A.type=B.id  and  type in (" + type + ") order by addtime desc limit " + rowsnum },
                success: function (myjson) {
                    var jsondatas = eval("(" + myjson + ")");
                    if (jsondatas.CODE > 0) {
                        actable = jsondatas.Table;
                        $("#message").find("tr").remove();
                        $(actable).each(function (i, n) {
                            $("#message").append(`<tr onclick='Location2Marker(` + JSON.stringify(n) + `)'><td  width="50px"><img src="../imgs/` + n.img + `.png" /></td><td>` + n.name + `</td><td width="30px"><img src="../imgs/pt.gif" /></td></tr>`);
                        });
                    } else {
                        layer.msg(jsondatas.MSG, { icon: 2 });
                    }
                },
                error: function () {
                    layer.msg("系统错误", { icon: 2 })
                },
                complete: function () {
                    layer.close(iiload);
                }
            });
        }
        getRoundStatus()
        function getRoundStatus() {
            $.ajax({
                type: "POST",  //访问WebService使用post方式请求
                cache: false,
                async: false,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                url: getRootPath() + "/Service/GetTable.ashx", //调用WebService的地址和方法名称组合
                data: { tableName: 'roadstatus', whereSql: '', pageNum: 1, rowsNum: 100 },
                success: function (myjson) {
                    var jsondatas = eval("(" + myjson + ")");
                    console.log(jsondatas)
                },
                error: function () {
                    layer.msg("系统错误", { icon: 2 })
                },
                complete: function () {
                    layer.close(iiload);
                }
            });
        }
        function Location2Marker(data) {
            console.log(data)
            var maker, index;
            // if (!data.target_type) return
            if (!data.target_type) {
                $(actable).each(function (i, n) {
                    if (n.id == data.id) {
                        index = i
                        maker = n;
                    }
                });
                var newData = getLineData(index)
                newData.maker = maker
                parent.postMessage(newData, '*');
                return
            }
            let result = getAccidentLine(rescuejson.features, data.target_type)
            data.line = result.geometry.coordinates[0];
            data.maker = data;

            // ['jy', 'subway', 'bus', 'car', 'train', 'tram']
            data.data = { 
                rescueName: result.properties.XLMC,
                id: 'bus' + Math.random(),
                carType: trafficType || 'car', // 模拟拥堵车辆类型
                hideMessage: true, // 隐藏货车信息
                refreshTime: 0.5,
                trafficIndex: Math.floor(data.line.length / 2),
                showType: 'car'
            };
            data.trafficData = {
                index: Math.floor(data.line.length / 2),
                line1Radius: 5,
                line2Radius: 2,
                times: 3
            }
            
            parent.postMessage(data, '*');
            // locationbyMark(maker,false);
            // console.log(maker, false)
        }
    </script>

</body>

</html>